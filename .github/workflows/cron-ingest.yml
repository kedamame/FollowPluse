name: Data Ingestion (every 6 hours)

on:
  schedule:
    # Run at 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger ingest job
        run: |
          curl -f -s "${{ secrets.APP_URL }}/api/jobs/ingest?secret=${{ secrets.CRON_SECRET }}"
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

  retention:
    runs-on: ubuntu-latest
    # Run retention only once a day (00:00 UTC)
    if: github.event.schedule == '0 0,6,12,18 * * *'
    steps:
      - name: Trigger retention job
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "00" ]; then
            curl -f -s "${{ secrets.APP_URL }}/api/jobs/retention?secret=${{ secrets.CRON_SECRET }}"
          fi
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
